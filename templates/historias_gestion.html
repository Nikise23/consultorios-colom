<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Historias Clínicas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .main-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      border-radius: 15px;
      margin-bottom: 2rem;
    }
    
    .search-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .patient-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      border-left: 4px solid #667eea;
      margin-bottom: 1rem;
    }
    
    .patient-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .stats-badge {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .sort-btn {
      background: none;
      border: none;
      color: #667eea;
      font-weight: 600;
      text-decoration: none;
    }

    .sort-btn:hover {
      color: #764ba2;
    }
    
    .sort-btn.active {
      color: #28a745;
    }
    
    .pagination-wrapper {
      background: white;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #6c757d;
    }
    
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .loading-state {
      text-align: center;
      padding: 2rem;
      color: #667eea;
    }
  </style>
</head>
<body>
  <div class="container-fluid py-4">
    
    <!-- Header -->
    <div class="main-header">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2><i class="bi bi-file-medical-fill"></i> Gestión de Historias Clínicas</h2>
          <p class="mb-0 opacity-75">Buscar y gestionar todas las historias clínicas de pacientes</p>
        </div>
        <div class="d-flex flex-column flex-sm-row gap-2">
          <a href="/turnos-medico" class="btn btn-light">
            <i class="bi bi-arrow-left"></i> <span class="d-none d-sm-inline">Volver a Turnos</span>
          </a>
          <a href="/inicio" class="btn btn-outline-light">
            <i class="bi bi-house"></i> <span class="d-none d-sm-inline">Inicio</span>
          </a>
        </div>
      </div>
    </div>

    <!-- Búsqueda y Filtros -->
    <div class="search-card">
      <div class="row align-items-end">
        <div class="col-12 col-md-6">
          <label for="busqueda" class="form-label">
            <i class="bi bi-search"></i> Buscar pacientes
          </label>
          <input 
            type="text" 
            id="busqueda" 
            class="form-control" 
            placeholder="Buscar por DNI, médico, fecha o consulta..."
            onkeyup="buscarConDelay()"
          >
        </div>
        <div class="col-12 col-md-3 mt-2 mt-md-0">
          <label for="ordenar-por" class="form-label">Ordenar por</label>
          <select id="ordenar-por" class="form-select" onchange="cargarPacientes()">
            <option value="fecha_consulta">Última consulta</option>
            <option value="medico">Médico</option>
            <option value="dni">DNI</option>
          </select>
        </div>
        <div class="col-12 col-md-3 mt-2 mt-md-0">
          <label for="orden" class="form-label">Orden</label>
          <select id="orden" class="form-select" onchange="cargarPacientes()">
            <option value="asc">Ascendente (A-Z)</option>
            <option value="desc">Descendente (Z-A)</option>
          </select>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-12">
          <div class="d-flex flex-column flex-sm-row justify-content-between align-items-center gap-2">
            <span id="resultado-info" class="text-muted"></span>
            <button class="btn btn-outline-primary btn-sm" onclick="limpiarBusqueda()">
              <i class="bi bi-arrow-clockwise"></i> Limpiar filtros
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Lista de Pacientes -->
    <div id="lista-pacientes">
      <div class="loading-state">
        <i class="bi bi-hourglass-split fs-1"></i>
        <p>Cargando historias clínicas...</p>
      </div>
    </div>

    <!-- Paginación -->
    <div id="paginacion-wrapper" class="pagination-wrapper" style="display: none;">
      <nav>
        <ul class="pagination justify-content-center mb-0" id="paginacion">
        </ul>
      </nav>
    </div>

  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let busquedaTimeout;
    let paginaActual = 1;
    let totalPaginas = 1;
    
    document.addEventListener('DOMContentLoaded', function() {
      cargarPacientes();
    });

    function buscarConDelay() {
      clearTimeout(busquedaTimeout);
      busquedaTimeout = setTimeout(() => {
        paginaActual = 1; // Resetear a primera página al buscar
        cargarPacientes();
      }, 500); // Esperar 500ms después del último keystroke
    }

    async function cargarPacientes(pagina = 1) {
      try {
        paginaActual = pagina;
        const busqueda = document.getElementById('busqueda').value.trim();
        const ordenarPor = document.getElementById('ordenar-por').value;
        const orden = document.getElementById('orden').value;
        
        const params = new URLSearchParams({
          busqueda: busqueda,
          pagina: pagina,
          por_pagina: 10,
          ordenar_por: ordenarPor,
          orden: orden
        });

        const response = await fetch(`/api/historias/buscar?${params}`);
        const data = await response.json();
        
        if (response.ok) {
          mostrarPacientes(data.pacientes);
          actualizarPaginacion(data);
          actualizarInfoResultados(data);
        } else {
          mostrarError('Error al cargar pacientes');
        }
      } catch (error) {
        console.error('Error:', error);
        mostrarError('Error de conexión');
      }
    }

    function mostrarPacientes(pacientes) {
      const container = document.getElementById('lista-pacientes');
      
      if (pacientes.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="bi bi-file-medical"></i>
            <h5>No se encontraron historias clínicas</h5>
            <p>Intenta modificar los criterios de búsqueda</p>
          </div>
        `;
        return;
      }

      let html = '';
      pacientes.forEach(p => {
        const paciente = p.paciente || { dni: p.dni, nombre: 'No encontrado', apellido: '', celular: '' };
        const fechaUltima = p.ultima_consulta ? new Date(p.ultima_consulta).toLocaleDateString('es-ES') : 'Sin consultas';
        const ultimaConsulta = (p.ultima_historia && p.ultima_historia.consulta_medica) ? p.ultima_historia.consulta_medica : 'Sin detalles';
        const medico = (p.ultima_historia && p.ultima_historia.medico) ? p.ultima_historia.medico : 'No especificado';
        
        html += `
          <div class="patient-card">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-4">
                  <h6 class="card-title mb-1">
                    <i class="bi bi-person-fill text-primary"></i> 
                    ${paciente.apellido}, ${paciente.nombre}
                  </h6>
                  <div class="text-muted small">
                    <div><i class="bi bi-card-text"></i> DNI: ${paciente.dni}</div>
                    <div><i class="bi bi-telephone"></i> ${paciente.celular || 'No especificado'}</div>
                    <div><i class="bi bi-hospital"></i> ${paciente.obra_social || 'No especificada'}</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <p class="mb-1"><strong>Última consulta:</strong> ${fechaUltima}</p>
                  <p class="mb-1"><strong>Médico:</strong> Dr. ${medico}</p>
                  <div class="text-muted small" style="max-height: 60px; overflow: hidden;">
                    ${ultimaConsulta.substring(0, 100)}${ultimaConsulta.length > 100 ? '...' : ''}
                  </div>
                </div>
                <div class="col-md-2 text-center">
                  <div class="stats-badge mb-2">
                    ${p.total_consultas} consulta${p.total_consultas !== 1 ? 's' : ''}
                  </div>
                </div>
                <div class="col-md-2 text-end">
                  <button 
                    class="btn btn-primary btn-sm mb-1 w-100" 
                    onclick="verHistoriaCompleta('${paciente.dni}')"
                  >
                    <i class="bi bi-file-medical"></i> Ver Historia
                  </button>
                  <button 
                    class="btn btn-outline-success btn-sm w-100" 
                    onclick="nuevaConsulta('${paciente.dni}')"
                  >
                    <i class="bi bi-plus-circle"></i> Nueva Consulta
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    function actualizarPaginacion(data) {
      totalPaginas = data.total_paginas;
      const paginacion = document.getElementById('paginacion');
      const wrapper = document.getElementById('paginacion-wrapper');
      
      if (totalPaginas <= 1) {
        wrapper.style.display = 'none';
        return;
      }
      
      wrapper.style.display = 'block';
      let html = '';
      
      // Botón anterior
      html += `
        <li class="page-item ${paginaActual === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="cargarPacientes(${paginaActual - 1})">
            <i class="bi bi-chevron-left"></i>
          </a>
        </li>
      `;
      
      // Números de página
      const inicio = Math.max(1, paginaActual - 2);
      const fin = Math.min(totalPaginas, paginaActual + 2);
      
      if (inicio > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="cargarPacientes(1)">1</a></li>`;
        if (inicio > 2) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
      }
      for (let i = inicio; i <= fin; i++) {
        html += `
          <li class="page-item ${i === paginaActual ? 'active' : ''}">
            <a class="page-link" href="#" onclick="cargarPacientes(${i})">${i}</a>
          </li>
        `;
      }
      
      if (fin < totalPaginas) {
        if (fin < totalPaginas - 1) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="cargarPacientes(${totalPaginas})">${totalPaginas}</a></li>`;
      }
      
      // Botón siguiente
      html += `
        <li class="page-item ${paginaActual === totalPaginas ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="cargarPacientes(${paginaActual + 1})">
            <i class="bi bi-chevron-right"></i>
          </a>
        </li>
      `;
      
      paginacion.innerHTML = html;
    }

    function actualizarInfoResultados(data) {
      const info = document.getElementById('resultado-info');
      const inicio = (data.pagina - 1) * data.por_pagina + 1;
      const fin = Math.min(data.pagina * data.por_pagina, data.total);
      
      info.textContent = `Mostrando ${inicio}-${fin} de ${data.total} pacientes con historias clínicas`;
    }

    function verHistoriaCompleta(dni) {
      window.location.href = `/historias?dni=${dni}`;
    }

    function nuevaConsulta(dni) {
      window.location.href = `/historias?dni=${dni}`;
    }

    function limpiarBusqueda() {
      document.getElementById('busqueda').value = '';
      document.getElementById('ordenar-por').value = 'apellido';
      document.getElementById('orden').value = 'asc';
      paginaActual = 1;
      cargarPacientes();
    }

    function mostrarError(mensaje) {
      const container = document.getElementById('lista-pacientes');
      container.innerHTML = `
        <div class="alert alert-danger" role="alert">
          <i class="bi bi-exclamation-triangle"></i> ${mensaje}
        </div>
      `;
    }
  </script>
</body>
</html>