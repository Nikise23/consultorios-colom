<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Secretar√≠a - Consultorio</title>
  
  <!-- Tailwind CSS & FontAwesome -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#2563eb',
            secondary: '#0891b2',
            success: '#059669',
            danger: '#dc2626',
            warning: '#d97706',
            info: '#7c3aed'
          }
        }
      }
    };
  </script>
  
  <style>
    /* Estilos personalizados para el dashboard */
    .stat-card {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
    }
    
    .action-btn {
      transition: all 0.3s ease;
    }
    
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
    }
    
    .search-container {
      transition: all 0.3s ease;
    }
    
    .table-container {
      transition: all 0.3s ease;
    }
    
    /* Animaciones */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .animate-fade-in-up {
      animation: fadeInUp 0.6s ease-out;
    }
    
    /* Scrollbar personalizado */
    .overflow-auto::-webkit-scrollbar {
      width: 6px;
    }
    
    .overflow-auto::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }
    
    .overflow-auto::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    
    .overflow-auto::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    /* Asegurar que el footer se muestre correctamente */
    footer {
      position: relative !important;
      z-index: 1 !important;
      clear: both !important;
    }
    
    /* Asegurar que los modales no interfieran con el footer */
    .modal {
      z-index: 1050 !important;
    }
    
    .modal-backdrop {
      z-index: 1040 !important;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <!-- Header -->
  <div class="bg-white shadow-lg border-b-4 border-primary">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="bg-primary p-3 rounded-full">
            <i class="fas fa-user-nurse text-white text-2xl"></i>
          </div>
          <div>
            <h1 class="text-3xl font-bold text-gray-900">Panel de Secretar√≠a</h1>
            <p class="text-gray-600">Bienvenido/a <span class="font-semibold text-primary" id="nombre-usuario"></span></p>
          </div>
        </div>
        <div class="flex items-center space-x-3">
          <div class="text-right">
            <p class="text-sm text-gray-500">√öltima actualizaci√≥n</p>
            <p class="text-sm font-medium text-gray-700" id="ultima-actualizacion">--:--</p>
          </div>
          <button onclick="actualizarDashboard()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-2">
            <i class="fas fa-sync-alt"></i>
            <span>Actualizar</span>
          </button>
          <button onclick="cerrarSesion()" class="bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-2">
            <i class="fas fa-sign-out-alt"></i>
            <span>Cerrar Sesi√≥n</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      
    <!-- Estad√≠sticas Principales -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Total Pacientes -->
      <div class="stat-card bg-white rounded-2xl p-6 shadow-lg border-l-4 border-success animate-fade-in-up">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600 mb-1">Total Pacientes</p>
            <p class="text-3xl font-bold text-gray-900" id="total-pacientes">0</p>
            <p class="text-xs text-gray-500 mt-1">Registrados en el sistema</p>
          </div>
          <div class="bg-success bg-opacity-10 p-3 rounded-full">
            <i class="fas fa-users text-success text-2xl"></i>
          </div>
        </div>
      </div>

      <!-- Turnos Totales -->
      <div class="stat-card bg-white rounded-2xl p-6 shadow-lg border-l-4 border-primary animate-fade-in-up">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600 mb-1">Turnos Totales</p>
            <p class="text-3xl font-bold text-gray-900" id="total-turnos">0</p>
            <p class="text-xs text-gray-500 mt-1">Programados</p>
          </div>
          <div class="bg-primary bg-opacity-10 p-3 rounded-full">
            <i class="fas fa-calendar-check text-primary text-2xl"></i>
          </div>
        </div>
      </div>
      
      <!-- Turnos Hoy -->
      <div class="stat-card bg-white rounded-2xl p-6 shadow-lg border-l-4 border-warning animate-fade-in-up">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600 mb-1">Turnos Hoy</p>
            <p class="text-3xl font-bold text-gray-900" id="turnos-hoy">0</p>
            <p class="text-xs text-gray-500 mt-1" id="fecha-hoy"></p>
          </div>
          <div class="bg-warning bg-opacity-10 p-3 rounded-full">
            <i class="fas fa-calendar-day text-warning text-2xl"></i>
          </div>
        </div>
      </div>

      <!-- Pendientes -->
      <div class="stat-card bg-white rounded-2xl p-6 shadow-lg border-l-4 border-danger animate-fade-in-up">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600 mb-1">Pendientes</p>
            <p class="text-3xl font-bold text-gray-900" id="turnos-pendientes">0</p>
            <p class="text-xs text-gray-500 mt-1">Sin atender</p>
          </div>
          <div class="bg-danger bg-opacity-10 p-3 rounded-full">
            <i class="fas fa-clock text-danger text-2xl"></i>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Estad√≠sticas Adicionales -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
      <!-- Pacientes con Datos Incompletos -->
      <div class="stat-card bg-white rounded-2xl p-6 shadow-lg border-l-4 border-info animate-fade-in-up cursor-pointer" onclick="scrollToRegistroRapido()" title="Click para ver detalles">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600 mb-1">Datos Incompletos</p>
            <p class="text-3xl font-bold text-gray-900" id="pacientes-incompletos">0</p>
            <p class="text-xs text-gray-500 mt-1" id="pacientes-incompletos-turnos">0 con turnos pendientes</p>
          </div>
          <div class="bg-info bg-opacity-10 p-3 rounded-full">
            <i class="fas fa-user-clock text-info text-2xl"></i>
          </div>
        </div>
      </div>
    </div>
      
    <!-- Estad√≠sticas Financieras -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Ingresos del D√≠a -->
      <div class="stat-card bg-white rounded-2xl p-6 shadow-lg border-l-4 border-success animate-fade-in-up">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600 mb-1">Ingresos del D√≠a</p>
            <p class="text-3xl font-bold text-gray-900" id="total-dia">$0</p>
            <p class="text-xs text-gray-500 mt-1" id="detalle-ingresos">0 pagos</p>
          </div>
          <div class="bg-success bg-opacity-10 p-3 rounded-full">
            <i class="fas fa-coins text-success text-2xl"></i>
          </div>
        </div>
      </div>
      
      <!-- Efectivo -->
      <div class="stat-card bg-white rounded-2xl p-6 shadow-lg border-l-4 border-primary animate-fade-in-up">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600 mb-1">Efectivo</p>
            <p class="text-3xl font-bold text-gray-900" id="total-efectivo-dia">$0</p>
            <p class="text-xs text-gray-500 mt-1" id="cantidad-efectivo-dia">0 pagos</p>
          </div>
          <div class="bg-primary bg-opacity-10 p-3 rounded-full">
            <i class="fas fa-money-bill-wave text-primary text-2xl"></i>
          </div>
        </div>
      </div>
      
      <!-- Transferencias -->
      <div class="stat-card bg-white rounded-2xl p-6 shadow-lg border-l-4 border-info animate-fade-in-up">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600 mb-1">Transferencias</p>
            <p class="text-3xl font-bold text-gray-900" id="total-transferencia-dia">$0</p>
            <p class="text-xs text-gray-500 mt-1" id="cantidad-transferencia-dia">0 pagos</p>
          </div>
          <div class="bg-info bg-opacity-10 p-3 rounded-full">
            <i class="fas fa-university text-info text-2xl"></i>
          </div>
        </div>
      </div>

      <!-- Pendientes Cobro -->
      <div class="stat-card bg-white rounded-2xl p-6 shadow-lg border-l-4 border-warning animate-fade-in-up">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600 mb-1">Pendientes Cobro</p>
            <p class="text-3xl font-bold text-gray-900" id="pendientes-cobro">0</p>
            <p class="text-xs text-gray-500 mt-1">Sin pagar</p>
          </div>
          <div class="bg-warning bg-opacity-10 p-3 rounded-full">
            <i class="fas fa-clock text-warning text-2xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Botones de Acci√≥n -->
    <div class="bg-white rounded-2xl p-8 shadow-lg mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
        <i class="fas fa-tools text-primary mr-3"></i>
        Acciones R√°pidas
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
        <a href="/pacientes" class="action-btn bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-xl text-center hover:from-blue-600 hover:to-blue-700 transition-all duration-200 flex flex-col items-center space-y-2">
          <i class="fas fa-user-plus text-2xl"></i>
          <span class="font-semibold">Registrar Pacientes</span>
        </a>
        <a href="/turnos" class="action-btn bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-xl text-center hover:from-green-600 hover:to-green-700 transition-all duration-200 flex flex-col items-center space-y-2">
          <i class="fas fa-clipboard-list text-2xl"></i>
          <span class="font-semibold">Gestionar Turnos</span>
        </a>
        <a href="/agenda" class="action-btn bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-xl text-center hover:from-purple-600 hover:to-purple-700 transition-all duration-200 flex flex-col items-center space-y-2">
          <i class="fas fa-calendar-week text-2xl"></i>
          <span class="font-semibold">Administrar Agenda</span>
        </a>
        <button onclick="mostrarBusquedaAvanzada()" class="action-btn bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-xl text-center hover:from-orange-600 hover:to-orange-700 transition-all duration-200 flex flex-col items-center space-y-2">
          <i class="fas fa-search text-2xl"></i>
          <span class="font-semibold">B√∫squeda Avanzada</span>
        </button>
        <button onclick="mostrarGestionPagos()" class="action-btn bg-gradient-to-r from-teal-500 to-teal-600 text-white p-4 rounded-xl text-center hover:from-teal-600 hover:to-teal-700 transition-all duration-200 flex flex-col items-center space-y-2">
          <i class="fas fa-cash-register text-2xl"></i>
          <span class="font-semibold">Gesti√≥n de Pagos</span>
        </button>
        <button onclick="mostrarGestionBloqueos()" class="action-btn bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-xl text-center hover:from-red-600 hover:to-red-700 transition-all duration-200 flex flex-col items-center space-y-2">
          <i class="fas fa-ban text-2xl"></i>
          <span class="font-semibold">Bloquear Agenda</span>
        </button>
      </div>
    </div>

    <!-- B√∫squeda R√°pida -->
    <div class="search-container bg-white rounded-2xl p-6 shadow-lg mb-8" id="busqueda-rapida">
      <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
        <i class="fas fa-search text-primary mr-3"></i>
        B√∫squeda R√°pida
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="relative">
          <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          <input type="text" id="buscar-paciente" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Buscar paciente por nombre o DNI">
        </div>
        <div class="relative">
          <i class="fas fa-calendar absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          <input type="date" id="buscar-fecha" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
          <small class="text-gray-500 text-xs mt-1 block">Opcional - Si no se especifica, muestra todos los turnos futuros</small>
        </div>
        <div class="flex gap-2">
          <button onclick="buscarPaciente()" class="flex-1 bg-primary hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-semibold transition-colors duration-200 flex items-center justify-center space-x-2">
            <i class="fas fa-search"></i>
            <span>Buscar</span>
          </button>
          <button onclick="limpiarBusqueda()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-semibold transition-colors duration-200 flex items-center justify-center space-x-2">
            <i class="fas fa-undo"></i>
            <span>Limpiar</span>
          </button>
        </div>
      </div>
    </div>

    <!-- B√∫squeda Avanzada -->
    <div class="search-container bg-white rounded-2xl p-6 shadow-lg mb-8 hidden" id="busqueda-avanzada">
      <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
        <i class="fas fa-filter text-primary mr-3"></i>
        B√∫squeda Avanzada
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">M√©dico</label>
          <select id="filtro-medico" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
            <option value="">Todos los m√©dicos</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
          <select id="filtro-estado" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
            <option value="">Todos los estados</option>
            <option value="sin atender">Sin atender</option>
            <option value="recepcionado">Recepcionado</option>
            <option value="sala de espera">Sala de espera</option>
            <option value="llamado">Llamado</option>
            <option value="atendido">Atendido</option>
            <option value="ausente">Ausente</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Obra Social</label>
          <input type="text" id="filtro-obra-social" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Obra social">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Acci√≥n</label>
          <button onclick="aplicarFiltrosAvanzados()" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors duration-200 flex items-center justify-center space-x-2">
            <i class="fas fa-filter"></i>
            <span>Aplicar Filtros</span>
          </button>
        </div>
      </div>
    </div>
      
    <!-- Gesti√≥n de Pagos -->
    <div class="search-container bg-white rounded-2xl p-6 shadow-lg mb-8 hidden" id="gestion-pagos">
      <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
        <i class="fas fa-cash-register text-primary mr-3"></i>
        Gesti√≥n de Pagos
      </h3>
        
      <!-- Controles de fecha y acciones -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Fecha</label>
          <div class="relative">
            <i class="fas fa-calendar absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <input type="date" id="fecha-pagos" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" value="" onchange="actualizarGestionPagos()">
          </div>
          <p class="text-sm text-gray-500 mt-1">Seleccione fecha para ver pagos y recepcionados</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Acciones</label>
          <div class="flex flex-wrap gap-2">
            <button onclick="mostrarModalNuevoPago()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors duration-200 flex items-center space-x-2">
              <i class="fas fa-plus-circle"></i>
              <span>Nuevo Pago</span>
            </button>
            <button onclick="actualizarGestionPagos()" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors duration-200 flex items-center space-x-2">
              <i class="fas fa-sync-alt"></i>
              <span>Actualizar</span>
            </button>
            <button onclick="exportarPagosCSV()" class="bg-info hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors duration-200 flex items-center space-x-2">
              <i class="fas fa-download"></i>
              <span>Exportar CSV</span>
            </button>
          </div>
        </div>
      </div> 
        
      <!-- Pacientes con Registro R√°pido (Pendientes de Completar Datos) -->
      <div id="pacientes-registro-rapido" class="mb-8" style="display: none;">
        <h4 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
          <i class="fas fa-user-clock text-info mr-2"></i>
          Pacientes con Registro R√°pido - Completar Datos
          <span class="ml-2 bg-info text-white px-2 py-1 rounded-full text-sm" id="count-registro-rapido">0</span>
        </h4>
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DNI</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="tabla-registro-rapido" class="bg-white divide-y divide-gray-200">
                <!-- Se cargan din√°micamente -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

<!-- Pacientes Recepcionados - Pendientes de Cobro -->
      <div id="pacientes-cobrar" class="mb-8">
        <h4 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
          <i class="fas fa-users text-warning mr-2"></i>
          Pacientes Recepcionados - Pendientes de Cobro
        </h4>
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Apellido</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DNI</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Obra Social</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">M√©dico</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="tabla-pacientes-cobrar" class="bg-white divide-y divide-gray-200">
                <!-- Se cargan din√°micamente -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Pacientes en Sala de Espera (Ya Cobrados) -->
      <div class="mb-8">
        <h4 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
          <i class="fas fa-hospital text-success mr-2"></i>
          Pacientes en Sala de Espera (Ya Cobrados)
        </h4>
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Apellido</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DNI</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Obra Social</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">M√©dico</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto Pagado</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo Pago</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora Cobro</th>
                </tr>
              </thead>
              <tbody id="tabla-pacientes-sala-espera" class="bg-white divide-y divide-gray-200">
                <!-- Se cargan din√°micamente -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
         
      <!-- Panel de Informaci√≥n - Flujo de Pagos -->
      <div id="info-flujo-pago" class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-6 mb-8">
        <div class="flex items-center space-x-3 mb-4">
          <div class="bg-blue-500 p-2 rounded-full">
            <i class="fas fa-info-circle text-white"></i>
          </div>
          <h4 class="text-lg font-bold text-blue-800">Flujo de Pagos</h4>
        </div>
        <div class="space-y-2 text-blue-700">
          <div class="flex items-center space-x-2">
            <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">1</span>
            <span><strong>Recepcionar:</strong> Cuando llega el paciente (Gesti√≥n de Turnos)</span>
          </div>
          <div class="flex items-center space-x-2">
            <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">2</span>
            <span><strong>Cobrar:</strong> Desde aqu√≠ o desde Gesti√≥n de Turnos</span>
          </div>
          <div class="flex items-center space-x-2">
            <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">3</span>
            <span><strong>M√©dico:</strong> Llamar desde sala de espera ‚Üí atender</span>
          </div>
        </div>
      </div>
        <!-- Payment History -->
        <div id="historial-pagos">
          <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-cash-register text-primary mr-2"></i>
            Pagos Registrados Hoy
          </h3>
          <!-- Resumen de totales por tipo de pago -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white border border-blue-200 rounded-lg p-4 text-center">
              <h6 class="text-blue-600 font-semibold mb-1">Efectivo</h6>
              <h5 class="text-xl font-bold text-gray-900 mb-0" id="total-efectivo-resumen">$0</h5>
              <small class="text-gray-500" id="cantidad-efectivo-resumen">0 pagos</small>
            </div>
            <div class="bg-white border border-purple-200 rounded-lg p-4 text-center">
              <h6 class="text-purple-600 font-semibold mb-1">Transferencias</h6>
              <h5 class="text-xl font-bold text-gray-900 mb-0" id="total-transferencia-resumen">$0</h5>
              <small class="text-gray-500" id="cantidad-transferencia-resumen">0 pagos</small>
            </div>
            <div class="bg-white border border-green-200 rounded-lg p-4 text-center">
              <h6 class="text-green-600 font-semibold mb-1">Obra Social</h6>
              <h5 class="text-xl font-bold text-gray-900 mb-0" id="total-obra-social-resumen">$0</h5>
              <small class="text-gray-500" id="cantidad-obra-social-resumen">0 consultas</small>
            </div>
            <div class="bg-white border border-orange-200 rounded-lg p-4 text-center">
              <h6 class="text-orange-600 font-semibold mb-1">Total Recaudado</h6>
              <h5 class="text-xl font-bold text-gray-900 mb-0" id="total-recaudado-resumen">$0</h5>
              <small class="text-gray-500">Efectivo + Transferencias</small>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
              <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3">Apellido</th>
                  <th scope="col" class="px-6 py-3">Nombre</th>
                  <th scope="col" class="px-6 py-3">DNI</th>
                  <th scope="col" class="px-6 py-3">Monto</th>
                  <th scope="col" class="px-6 py-3">Obra Social</th>
                  <th scope="col" class="px-6 py-3">Tipo de Pago</th>
                  <th scope="col" class="px-6 py-3">Observaciones</th>
                  <th scope="col" class="px-6 py-3">Acciones</th>
                </tr>
              </thead>
              <tbody id="tabla-pagos-hoy" class="bg-white divide-y divide-gray-200">
              </tbody>
            </table>
          </div>
        </div>
      </div>

        <!-- Results Table -->
      <div class="table-container bg-white rounded-xl p-6 shadow-lg mb-8" id="tabla-resultados">
        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
          <i class="fas fa-calendar-day text-primary mr-3"></i>
          Turnos de Hoy
        </h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left text-gray-500">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3">Hora</th>
                <th scope="col" class="px-6 py-3">Paciente</th>
                <th scope="col" class="px-6 py-3">DNI</th>
                <th scope="col" class="px-6 py-3">M√©dico</th>
                <th scope="col" class="px-6 py-3">Estado</th>
                <th scope="col" class="px-6 py-3">Obra Social</th>
                <th scope="col" class="px-6 py-3">Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-turnos-body" class="bg-white divide-y divide-gray-200">
              <!-- Datos se cargan din√°micamente -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Gesti√≥n de Bloqueos de Agenda -->
      <div class="search-container bg-white rounded-2xl p-6 shadow-lg mb-8 hidden" id="gestion-bloqueos">
        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
          <i class="fas fa-ban text-primary mr-3"></i>
          Bloquear Agenda (Vacaciones)
        </h3>
        
        <!-- Formulario para crear bloqueo -->
        <div class="bg-gray-50 rounded-xl p-6 mb-6">
          <h4 class="text-lg font-semibold text-gray-900 mb-4">Nuevo Bloqueo</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">M√©dico *</label>
              <select id="bloqueo-medico" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                <option value="">Seleccione un m√©dico</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Motivo</label>
              <input type="text" id="bloqueo-motivo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Ej: Vacaciones, Licencia m√©dica">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Fecha Inicio *</label>
              <input type="date" id="bloqueo-fecha-inicio" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Fecha Fin *</label>
              <input type="date" id="bloqueo-fecha-fin" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
          </div>
          <button onclick="crearBloqueo()" class="bg-primary hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors duration-200">
            <i class="fas fa-ban mr-2"></i> Crear Bloqueo
          </button>
        </div>
        
        <!-- Lista de bloqueos activos -->
        <div>
          <h4 class="text-lg font-semibold text-gray-900 mb-4">Bloqueos Activos</h4>
          <div id="lista-bloqueos" class="space-y-3">
            <p class="text-gray-500 text-center py-4">Cargando bloqueos...</p>
          </div>
        </div>
      </div>

      <!-- Bot√≥n Volver al Panel Principal -->
      <div class="mb-6">
        <a href="/" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold transition-colors duration-200 flex items-center space-x-2 inline-flex">
          <i class="fas fa-arrow-left"></i>
          <span>Volver al Panel Principal</span>
        </a>
      </div>
      
    </div>
<!-- Bot√≥n para vaciar turnos vencidos (solo secretaria) -->
<div class="mb-4 text-end">
  <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors duration-200 flex items-center space-x-2" onclick="vaciarTurnosVencidos()">
    <i class="fas fa-trash"></i> 
    <span>Vaciar turnos vencidos (24hs)</span>
  </button>
</div>
<!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let pacientes = [];
    let turnos = [];
    let medicos = [];
    let pagos = [];
    let estadisticasPagos = {};
    
    // Cargar datos iniciales
    async function cargarDatos() {
      try {
        // Cargar pacientes
        const resPacientes = await fetch('/api/pacientes');
        pacientes = await resPacientes.json();
        cargarPacientesRegistroRapido();
        
        // Cargar turnos
        const resTurnos = await fetch('/api/turnos');
        turnos = await resTurnos.json();
        
        // Cargar pagos
        const resPagos = await fetch('/api/pagos');
        pagos = await resPagos.json();
        
        // Cargar estad√≠sticas de pagos del d√≠a seleccionado
        const fechaHoy = new Date();
        const fechaPagosElement = document.getElementById('fecha-pagos');
        const fechaSeleccionada = (fechaPagosElement && fechaPagosElement.value) || `${fechaHoy.getFullYear()}-${String(fechaHoy.getMonth() + 1).padStart(2, '0')}-${String(fechaHoy.getDate()).padStart(2, '0')}`;
        const resEstadisticas = await fetch(`/api/pagos/estadisticas?fecha=${fechaSeleccionada}`);
        estadisticasPagos = await resEstadisticas.json();

        // Extraer m√©dicos √∫nicos
        medicos = [...new Set(turnos.map(t => t.medico))];
        
        // Actualizar estad√≠sticas
        await actualizarEstadisticas();
        
        // Cargar tabla de turnos de hoy
        await cargarTurnosHoy();
        
        // Configurar fechas a hoy
        const fechaActual = new Date().toISOString().split('T')[0];
        document.getElementById('fecha-pagos').value = fechaActual;
        document.getElementById('buscar-fecha').value = fechaActual;
        
        // Configurar fecha de pagos a hoy
        document.getElementById('fecha-pagos').value = new Date().toISOString().split('T')[0];
        
        // Cargar pacientes recepcionados y en sala de espera
        cargarPacientesRecepcionados();
        cargarPacientesSalaEspera();
      
      } catch (error) {
        console.error('Error cargando datos:', error);
      }
    }
     
    async function actualizarEstadisticas() {
      const hoy = new Date().toISOString().split('T')[0];
      const turnosHoy = Array.isArray(turnos) ? turnos.filter(t => (t.fecha_turno || t.fecha) === hoy) : [];
      const turnosPendientes = Array.isArray(turnos) ? turnos.filter(t => ['sin atender', 'llamado'].includes(t.estado)) : [];
      
      // Obtener pacientes recepcionados pendientes de cobro
      let pacientesRecepcionados = 0;
      try {
        const response = await fetch(`/api/pacientes/recepcionados?fecha=${hoy}`);
        const recepcionados = await response.json();
        pacientesRecepcionados = recepcionados.length;
      } catch (error) {
        console.error('Error obteniendo recepcionados:', error);
      }
      const totalPacientesEl = document.getElementById('total-pacientes');
      if (totalPacientesEl) totalPacientesEl.textContent = (pacientes || []).length;
      
      const totalTurnosEl = document.getElementById('total-turnos');
      if (totalTurnosEl) totalTurnosEl.textContent = (turnos || []).length;
      
      const turnosHoyEl = document.getElementById('turnos-hoy');
      if (turnosHoyEl) turnosHoyEl.textContent = turnosHoy.length;
      
      const turnosPendientesEl = document.getElementById('turnos-pendientes');
      if (turnosPendientesEl) turnosPendientesEl.textContent = turnosPendientes.length;
      
      const pendientesCobroEl = document.getElementById('pendientes-cobro');
      if (pendientesCobroEl) pendientesCobroEl.textContent = pacientesRecepcionados;
      
    
     
      // Actualizar estad√≠sticas de pagos
      const totalDiaEl = document.getElementById('total-dia');
      if (totalDiaEl) totalDiaEl.textContent = `$${estadisticasPagos.total_dia || 0}`;

      // Actualizar estad√≠sticas por tipo de pago del d√≠a
      const totalEfectivoDiaEl = document.getElementById('total-efectivo-dia');
      if (totalEfectivoDiaEl) totalEfectivoDiaEl.textContent = `$${estadisticasPagos.total_efectivo_hoy || 0}`;
      
      const totalTransferenciaDiaEl = document.getElementById('total-transferencia-dia');
      if (totalTransferenciaDiaEl) totalTransferenciaDiaEl.textContent = `$${estadisticasPagos.total_transferencia_hoy || 0}`;
      
      const cantidadEfectivoDiaEl = document.getElementById('cantidad-efectivo-dia');
      if (cantidadEfectivoDiaEl) cantidadEfectivoDiaEl.textContent = `${estadisticasPagos.pagos_efectivo_hoy || 0} pagos`;
      
      const cantidadTransferenciaDiaEl = document.getElementById('cantidad-transferencia-dia');
      if (cantidadTransferenciaDiaEl) cantidadTransferenciaDiaEl.textContent = `${estadisticasPagos.pagos_transferencia_hoy || 0} pagos`;
      
      const detalleIngresosEl = document.getElementById('detalle-ingresos');
      if (detalleIngresosEl) detalleIngresosEl.textContent = `${estadisticasPagos.cantidad_pagos_dia || 0} pagos`;

    }
    
    async function cargarTurnosHoy() {
      const hoy = new Date().toISOString().split('T')[0];
      try {
         // Usar la API espec√≠fica para turnos del d√≠a que incluye informaci√≥n del paciente
        const response = await fetch(`/api/turnos/dia?fecha=${hoy}`);
        const turnosHoy = await response.json();
        mostrarTurnosEnTabla(turnosHoy);
       } catch (error) {
        console.error('Error cargando turnos de hoy:', error);
        // Fallback: usar datos ya cargados
        const turnosHoy = turnos.filter(t => t.fecha === hoy);
        mostrarTurnosEnTabla(turnosHoy);
      }
    }
    
    function mostrarTurnosEnTabla(turnosMostrar) {
      const tbody = document.getElementById('tabla-turnos-body');
      tbody.innerHTML = '';
      
      if (turnosMostrar.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No hay turnos para mostrar hoy</td></tr>';
        return;
      }
      // Ordenar por hora
      turnosMostrar.sort((a, b) => (a.hora || '00:00').localeCompare(b.hora || '00:00'));
       
      turnosMostrar.forEach(turno => {
        // Usar paciente enriquecido de la API o buscar en el array local
        const paciente = turno.paciente || pacientes.find(p => p.dni === turno.dni_paciente) || {};
        
        // Verificar si el paciente tiene datos incompletos
        const datosIncompletos = paciente.registro_rapido || paciente.incompleto || 
          (paciente.nombre === 'Pendiente' || paciente.apellido === 'Pendiente');
         
        // Colores para todos los estados
        const estadoColor = {
          'sin atender': 'bg-gray-100 text-gray-800',
          'recepcionado': 'bg-green-100 text-green-800',
          'sala de espera': 'bg-blue-100 text-blue-800',
          'llamado': 'bg-yellow-100 text-yellow-800',
          'atendido': 'bg-green-100 text-green-800',
          'ausente': 'bg-red-100 text-red-800'
        }[turno.estado] || 'bg-gray-100 text-gray-800';

        // Iconos para cada estado
        const estadoIcon = {
          'sin atender': '‚è≥',
          'recepcionado': '‚úÖ',
          'sala de espera': 'üè•',
          'llamado': 'üìû',
          'atendido': '‚úîÔ∏è',
          'ausente': '‚ùå'
        }[turno.estado] || '‚è≥';
        
        const row = document.createElement('tr');
        // Resaltar fila si tiene datos incompletos
        row.className = datosIncompletos ? 'hover:bg-gray-50 bg-yellow-50 border-l-4 border-warning' : 'hover:bg-gray-50';
        // Badge para datos incompletos
        const badgeIncompleto = datosIncompletos ? 
          '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-warning text-white ml-2" title="Paciente con datos incompletos - Completar en recepci√≥n"><i class="fas fa-exclamation-triangle mr-1"></i> Datos Incompletos</span>' : '';
        
        row.innerHTML = `
          <td class="px-6 py-4 font-semibold text-gray-900">${turno.hora}</td>
          <td class="px-6 py-4 text-gray-900">
            ${paciente.nombre || ''} ${paciente.apellido || ''}
            ${badgeIncompleto}
          </td>
          <td class="px-6 py-4 text-gray-600">${turno.dni_paciente}</td>
          <td class="px-6 py-4 text-gray-900">${turno.medico}</td>
          <td class="px-6 py-4">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${estadoColor}">
              ${estadoIcon} ${turno.estado}
            </span>
          </td>
          <td class="px-6 py-4 text-gray-600">${paciente.obra_social || '-'}</td>
          <td class="px-6 py-4">
            <div class="flex space-x-2">
              ${datosIncompletos ? `<a href="/pacientes?dni=${turno.dni_paciente}" class="bg-warning hover:bg-warning-dark text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors duration-200 inline-flex items-center" title="Completar datos del paciente"><i class="fas fa-user-edit mr-1"></i> Completar</a>` : ''}
              <button class="bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded-lg text-sm font-medium transition-colors duration-200" onclick="editarTurno('${turno.dni_paciente}', '${turno.fecha}', '${turno.hora}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded-lg text-sm font-medium transition-colors duration-200" onclick="eliminarTurno('${turno.dni_paciente}', '${turno.fecha}', '${turno.hora}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function cargarOpcionesMedicos() {
      const select = document.getElementById('filtro-medico');
      medicos.forEach(medico => {
        const option = document.createElement('option');
        option.value = medico;
        option.textContent = medico;
        select.appendChild(option);
      });
    }
    
    function mostrarBusquedaAvanzada() {
      const busquedaAvanzada = document.getElementById('busqueda-avanzada');
      const isHidden = busquedaAvanzada.classList.contains('hidden');
      
      if (isHidden) {
        busquedaAvanzada.classList.remove('hidden');
      } else {
        busquedaAvanzada.classList.add('hidden');
      }
    }
    
    // Esta funci√≥n est√° duplicada, se usa la de m√°s abajo (buscarPaciente con modal)
    // Se mantiene por compatibilidad pero se recomienda usar la versi√≥n mejorada
    
    async function limpiarBusqueda() {
      document.getElementById('buscar-paciente').value = '';
      document.getElementById('buscar-fecha').value = '';
      await cargarTurnosHoy();
    }
    
    async function aplicarFiltrosAvanzados() {
      const medico = document.getElementById('filtro-medico').value;
      const estado = document.getElementById('filtro-estado').value;
      const obraSocial = document.getElementById('filtro-obra-social').value.toLowerCase();
      const fecha = document.getElementById('buscar-fecha').value || new Date().toISOString().split('T')[0];

      try {
        // Obtener turnos m√°s recientes de la fecha
        const response = await fetch(`/api/turnos/dia?fecha=${fecha}`);
        let turnosFiltrados = await response.json();
         
        if (medico) {
          turnosFiltrados = turnosFiltrados.filter(t => t.medico === medico);
        }
         
        if (estado) {
          turnosFiltrados = turnosFiltrados.filter(t => t.estado === estado);
        }
         
        if (obraSocial) {
          turnosFiltrados = turnosFiltrados.filter(turno => {
            const paciente = turno.paciente || {};
            return paciente.obra_social && paciente.obra_social.toLowerCase().includes(obraSocial);
          });
        }
         
        mostrarTurnosEnTabla(turnosFiltrados);
      } catch (error) {
        console.error('Error aplicando filtros:', error);
        alert('Error al aplicar filtros');
      }
    }

    async function editarTurno(dni, fecha, hora) {
      const nuevaHora = prompt('Ingrese la nueva hora (HH:MM):', hora);
      const nuevaFecha = prompt('Ingrese la nueva fecha (YYYY-MM-DD):', fecha);
      
      if ((nuevaHora && nuevaHora !== hora) || (nuevaFecha && nuevaFecha !== fecha)) {
        try {
          const data = {};
          if (nuevaHora && nuevaHora !== hora) data.nueva_hora = nuevaHora;
          if (nuevaFecha && nuevaFecha !== fecha) data.nueva_fecha = nuevaFecha;
          
          const response = await fetch(`/api/turnos/${dni}/${fecha}/${hora}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('Turno actualizado correctamente');
            // Actualizar en memoria sin recargar todo
            const idx = turnos.findIndex(t => t.dni_paciente === dni && (t.fecha_turno || t.fecha) === fecha && (t.hora_turno || t.hora) === hora);
            if (idx !== -1) {
              if (data.nueva_hora) {
                if (turnos[idx].hora_turno !== undefined) turnos[idx].hora_turno = data.nueva_hora; else turnos[idx].hora = data.nueva_hora;
              }
              if (data.nueva_fecha) {
                if (turnos[idx].fecha_turno !== undefined) turnos[idx].fecha_turno = data.nueva_fecha; else turnos[idx].fecha = data.nueva_fecha;
              }
            }
            // Refrescar solo la tabla y estad√≠sticas
            await cargarTurnosHoy();
            await actualizarEstadisticas();
          } else {
            alert('Error: ' + result.error);
          }
        } catch (error) {
          alert('Error al actualizar el turno: ' + error.message);
        }
      }
    }

    async function eliminarTurno(dni, fecha, hora) {
      if (confirm('¬øEst√° seguro de que desea eliminar este turno?')) {
        try {
          const response = await fetch(`/api/turnos/${dni}/${fecha}/${hora}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            }
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('Turno eliminado correctamente');
            // Quitar de memoria y refrescar vistas parciales
            turnos = turnos.filter(t => !(t.dni_paciente === dni && (t.fecha_turno || t.fecha) === fecha && (t.hora_turno || t.hora) === hora));
            await cargarTurnosHoy();
            await actualizarEstadisticas();
          } else {
            alert('Error: ' + result.error);
          }
        } catch (error) {
          alert('Error al eliminar el turno: ' + error.message);
        }
      }
    }

    // === FUNCIONES DE PAGOS ===
    
    function mostrarGestionPagos() {
      const gestionPagos = document.getElementById('gestion-pagos');
      const isHidden = gestionPagos.classList.contains('hidden');
      
      console.log('Mostrando gesti√≥n de pagos, isHidden:', isHidden);
      
      if (isHidden) {
        gestionPagos.classList.remove('hidden');
        console.log('Cargando datos de gesti√≥n de pagos...');
        cargarPacientesRecepcionados();
        cargarPacientesSalaEspera();
        cargarPagosHoy();
      } else {
        gestionPagos.classList.add('hidden');
      }
    }

    function mostrarGestionBloqueos() {
      const gestionBloqueos = document.getElementById('gestion-bloqueos');
      const isHidden = gestionBloqueos.classList.contains('hidden');
      
      if (isHidden) {
        gestionBloqueos.classList.remove('hidden');
        cargarMedicosParaBloqueos();
        cargarBloqueos();
        
        // Scroll suave hacia la secci√≥n de bloqueos
        setTimeout(() => {
          gestionBloqueos.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      } else {
        gestionBloqueos.classList.add('hidden');
      }
    }

    async function cargarMedicosParaBloqueos() {
      try {
        const response = await fetch('/api/usuarios');
        const usuarios = await response.json();
        const medicosList = usuarios.filter(u => u.rol === 'medico' && u.activo);
        
        const select = document.getElementById('bloqueo-medico');
        select.innerHTML = '<option value="">Seleccione un m√©dico</option>';
        
        medicosList.forEach(medico => {
          const option = document.createElement('option');
          option.value = medico.usuario;
          option.textContent = `${medico.nombre_completo || medico.usuario}${medico.especialidad ? ' - ' + medico.especialidad : ''}`;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error al cargar m√©dicos:', error);
      }
    }

    async function cargarBloqueos() {
      try {
        const response = await fetch('/api/bloqueos-agenda');
        const bloqueos = await response.json();
        
        const container = document.getElementById('lista-bloqueos');
        
        if (bloqueos.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay bloqueos activos</p>';
          return;
        }
        
        container.innerHTML = bloqueos.map(bloqueo => {
          const fechaInicio = new Date(bloqueo.fecha_inicio + 'T00:00:00');
          const fechaFin = new Date(bloqueo.fecha_fin + 'T00:00:00');
          
          return `
            <div class="bg-white border border-gray-200 rounded-lg p-4 flex items-center justify-between">
              <div>
                <h5 class="font-semibold text-gray-900">${bloqueo.medico}</h5>
                <p class="text-sm text-gray-600">
                  ${fechaInicio.toLocaleDateString('es-ES')} - ${fechaFin.toLocaleDateString('es-ES')}
                </p>
                ${bloqueo.motivo ? `<p class="text-sm text-gray-500">${bloqueo.motivo}</p>` : ''}
              </div>
              <button onclick="eliminarBloqueo(${bloqueo.id})" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                <i class="fas fa-trash mr-1"></i> Eliminar
              </button>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error al cargar bloqueos:', error);
        document.getElementById('lista-bloqueos').innerHTML = '<p class="text-red-500">Error al cargar bloqueos</p>';
      }
    }

    async function crearBloqueo() {
      const medico = document.getElementById('bloqueo-medico').value;
      const fechaInicio = document.getElementById('bloqueo-fecha-inicio').value;
      const fechaFin = document.getElementById('bloqueo-fecha-fin').value;
      const motivo = document.getElementById('bloqueo-motivo').value;
      
      if (!medico || !fechaInicio || !fechaFin) {
        alert('Por favor complete todos los campos requeridos');
        return;
      }
      
      try {
        const response = await fetch('/api/bloqueos-agenda', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            medico: medico,
            fecha_inicio: fechaInicio,
            fecha_fin: fechaFin,
            motivo: motivo
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('Bloqueo creado correctamente');
          document.getElementById('bloqueo-medico').value = '';
          document.getElementById('bloqueo-fecha-inicio').value = '';
          document.getElementById('bloqueo-fecha-fin').value = '';
          document.getElementById('bloqueo-motivo').value = '';
          cargarBloqueos();
        } else {
          alert(result.error || 'Error al crear bloqueo');
        }
      } catch (error) {
        alert('Error al crear bloqueo: ' + error.message);
      }
    }

    async function eliminarBloqueo(id) {
      if (!confirm('¬øEst√° seguro de eliminar este bloqueo?')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/bloqueos-agenda/${id}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('Bloqueo eliminado correctamente');
          cargarBloqueos();
        } else {
          alert(result.error || 'Error al eliminar bloqueo');
        }
      } catch (error) {
        alert('Error al eliminar bloqueo: ' + error.message);
      }
    }
    
    function actualizarGestionPagos() {
      cargarPacientesRecepcionados();
      cargarPacientesSalaEspera();
      cargarPagosHoy();
    }

    
    async function cargarPagosHoy() {
      const fecha = document.getElementById('fecha-pagos').value || new Date().toISOString().split('T')[0];
      const pagosHoy = pagos.filter(p => p.fecha === fecha);
      
      console.log('Cargando pagos para fecha:', fecha);
      console.log('Pagos encontrados:', pagosHoy.length);
      
      const tbody = document.getElementById('tabla-pagos-hoy');
      tbody.innerHTML = '';
      
      if (pagosHoy.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">No hay pagos registrados para esta fecha</td></tr>';
        
        // Limpiar resumen cuando no hay pagos
        document.getElementById('total-efectivo-resumen').textContent = '$0';
        document.getElementById('total-transferencia-resumen').textContent = '$0';
        document.getElementById('total-obra-social-resumen').textContent = '$0';
        document.getElementById('total-recaudado-resumen').textContent = '$0';
        document.getElementById('cantidad-efectivo-resumen').textContent = '0 pagos';
        document.getElementById('cantidad-transferencia-resumen').textContent = '0 pagos';
        document.getElementById('cantidad-obra-social-resumen').textContent = '0 consultas';
        return;
      }

      // Calcular totales por tipo de pago
      let totalEfectivo = 0;
      let totalTransferencia = 0;
      let totalObraSocial = 0;
      let cantidadEfectivo = 0;
      let cantidadTransferencia = 0;
      let cantidadObraSocial = 0;

      pagosHoy.forEach(pago => {
        const row = document.createElement('tr');
        const paciente = pacientes.find(p => p.dni === pago.dni_paciente) || {};
        
        // Determinar color del monto seg√∫n si es gratis o pagado
        const montoColor = pago.monto == 0 ? 'text-green-600' : 'text-blue-600';
        const montoTexto = pago.monto == 0 ? 'Obra Social' : `$${pago.monto}`;
         
        // Determinar tipo de pago y su badge
        let tipoPagoBadge = '';
        if (pago.monto == 0) {
          tipoPagoBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Obra Social</span>';
          totalObraSocial += pago.monto;
          cantidadObraSocial++;
        } else {
          const tipoPago = pago.tipo_pago || 'efectivo';
          const badgeClass = tipoPago === 'efectivo' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800';
          const badgeText = tipoPago === 'efectivo' ? 'Efectivo' : 'Transferencia';
          tipoPagoBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${badgeClass}">${badgeText}</span>`;
          
          if (tipoPago === 'efectivo') {
            totalEfectivo += pago.monto;
            cantidadEfectivo++;
          } else {
            totalTransferencia += pago.monto;
            cantidadTransferencia++;
          }
        }

        row.innerHTML = `
          <td class="px-6 py-4 text-gray-900">${paciente.apellido || ''}</td>
          <td class="px-6 py-4 text-gray-900">${paciente.nombre || ''}</td>
          <td class="px-6 py-4 text-gray-600">${pago.dni_paciente}</td>
          <td class="px-6 py-4 font-semibold ${montoColor}">${montoTexto}</td>
          <td class="px-6 py-4 text-gray-600">${pago.obra_social || '-'}</td>
          <td class="px-6 py-4">${tipoPagoBadge}</td>
          <td class="px-6 py-4 text-gray-600">${pago.observaciones || '-'}</td>
          <td class="px-6 py-4">
            <button class="bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded-lg text-sm font-medium transition-colors duration-200" onclick="eliminarPago(${pago.id}, '${pago.nombre_paciente}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
      // Actualizar resumen de totales
      document.getElementById('total-efectivo-resumen').textContent = `$${totalEfectivo}`;
      document.getElementById('total-transferencia-resumen').textContent = `$${totalTransferencia}`;
      document.getElementById('total-obra-social-resumen').textContent = `$${totalObraSocial}`;
      document.getElementById('total-recaudado-resumen').textContent = `$${totalEfectivo + totalTransferencia}`;
      document.getElementById('cantidad-efectivo-resumen').textContent = `${cantidadEfectivo} pagos`;
      document.getElementById('cantidad-transferencia-resumen').textContent = `${cantidadTransferencia} pagos`;
      document.getElementById('cantidad-obra-social-resumen').textContent = `${cantidadObraSocial} consultas`;
    }
    
    async function cargarPacientesRecepcionados() {
      const fecha = document.getElementById('fecha-pagos').value || new Date().toISOString().split('T')[0];
      
      try {
        console.log('Cargando pacientes recepcionados para fecha:', fecha);
        const response = await fetch(`/api/pacientes/recepcionados?fecha=${fecha}`);
        const pacientesRecepcionados = await response.json();
        
        console.log('Pacientes recepcionados encontrados:', pacientesRecepcionados.length);
        
        const tbody = document.getElementById('tabla-pacientes-cobrar');
        tbody.innerHTML = '';
        
        if (pacientesRecepcionados.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">No hay pacientes recepcionados pendientes de cobro</td></tr>';
          return;
        }
        
        pacientesRecepcionados.forEach(paciente => {
          const row = document.createElement('tr');
          row.className = 'bg-yellow-50 hover:bg-yellow-100'; // Resaltar que est√°n pendientes
          
          row.innerHTML = `
            <td class="px-6 py-4 font-semibold text-gray-900">${paciente.hora}</td>
            <td class="px-6 py-4 text-gray-900">${paciente.apellido}</td>
            <td class="px-6 py-4 text-gray-900">${paciente.nombre}</td>
            <td class="px-6 py-4 text-gray-600">${paciente.dni}</td>
            <td class="px-6 py-4 text-gray-600">${paciente.obra_social || '-'}</td>
            <td class="px-6 py-4 text-gray-900">${paciente.medico}</td>
            <td class="px-6 py-4">
              <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" 
                     id="monto-${paciente.dni}" placeholder="0.00" step="0.01" min="0">
            </td>
            <td class="px-6 py-4">
              <button class="bg-green-100 hover:bg-green-200 text-green-800 px-3 py-1 rounded-lg text-sm font-medium transition-colors duration-200"
                     onclick="cobrarPacienteRecepcionado('${paciente.dni}', '${fecha}')">
                <i class="fas fa-cash-register"></i> Cobrar
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });
        
      } catch (error) {
        console.error('Error cargando pacientes recepcionados:', error);
      }
    }

    async function cargarPacientesSalaEspera() {
      const fecha = document.getElementById('fecha-pagos').value || new Date().toISOString().split('T')[0];
      
      try {
        console.log('Cargando pacientes en sala de espera para fecha:', fecha);
        const response = await fetch(`/api/pacientes/sala-espera?fecha=${fecha}`);
        const pacientesSalaEspera = await response.json();
        
        console.log('Pacientes en sala de espera encontrados:', pacientesSalaEspera.length);
        
        const tbody = document.getElementById('tabla-pacientes-sala-espera');
        tbody.innerHTML = '';
        
        if (pacientesSalaEspera.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">No hay pacientes en sala de espera</td></tr>';
          return;
        }
        
        pacientesSalaEspera.forEach(paciente => {
          const row = document.createElement('tr');
          row.className = 'bg-green-50 hover:bg-green-100'; // Resaltar que ya est√°n cobrados
          
          // Determinar tipo de pago y su badge
          let tipoPagoBadge = '';
          if (paciente.monto_pagado == 0) {
            tipoPagoBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Obra Social</span>';
          } else {
            const badgeClass = paciente.tipo_pago === 'efectivo' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800';
            const badgeText = paciente.tipo_pago === 'efectivo' ? 'Efectivo' : 'Transferencia';
            tipoPagoBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${badgeClass}">${badgeText}</span>`;
          }
          
          // Determinar color del monto
          const montoColor = paciente.monto_pagado == 0 ? 'text-green-600' : 'text-blue-600';
          const montoTexto = paciente.monto_pagado == 0 ? 'Obra Social' : `$${paciente.monto_pagado}`;
          
          row.innerHTML = `
            <td class="px-6 py-4 font-semibold text-gray-900">${paciente.hora}</td>
            <td class="px-6 py-4 text-gray-900">${paciente.apellido}</td>
            <td class="px-6 py-4 text-gray-900">${paciente.nombre}</td>
            <td class="px-6 py-4 text-gray-600">${paciente.dni}</td>
            <td class="px-6 py-4 text-gray-600">${paciente.obra_social || '-'}</td>
            <td class="px-6 py-4 text-gray-900">${paciente.medico}</td>
            <td class="px-6 py-4 font-semibold ${montoColor}">${montoTexto}</td>
            <td class="px-6 py-4">${tipoPagoBadge}</td>
            <td class="px-6 py-4 text-gray-600"><small>${paciente.hora_cobro || '-'}</small></td>
          `;
          tbody.appendChild(row);
        });
      } catch (error) {
        console.error('Error cargando pacientes en sala de espera:', error);
      }
    }

    async function cargarPacientesRegistroRapido() {
      try {
        // Usar el array de pacientes ya cargado
        const pacientesRegistroRapido = pacientes.filter(p => p.registro_rapido);
        
        const container = document.getElementById('pacientes-registro-rapido');
        const tbody = document.getElementById('tabla-registro-rapido');
        const countBadge = document.getElementById('count-registro-rapido');
        
        if (pacientesRegistroRapido.length === 0) {
          container.style.display = 'none';
          // Actualizar estad√≠sticas
          document.getElementById('pacientes-incompletos').textContent = '0';
          document.getElementById('pacientes-incompletos-turnos').textContent = '0 con turnos pendientes';
          return;
        }
        
        container.style.display = 'block';
        countBadge.textContent = pacientesRegistroRapido.length;
        tbody.innerHTML = '';
        
        // Obtener turnos pendientes para cada paciente
        const hoy = new Date().toISOString().split('T')[0];
        const turnosPendientes = Array.isArray(turnos) ? turnos.filter(t => {
          const fechaTurno = t.fecha_turno || t.fecha || '';
          return fechaTurno >= hoy && ['sin atender', 'recepcionado'].includes(t.estado);
        }) : [];
        
        // Contar pacientes con turnos pendientes
        const pacientesConTurnos = new Set();
        turnosPendientes.forEach(t => {
          if (pacientesRegistroRapido.some(p => p.dni === t.dni_paciente)) {
            pacientesConTurnos.add(t.dni_paciente);
          }
        });
        
        // Actualizar estad√≠sticas
        document.getElementById('pacientes-incompletos').textContent = pacientesRegistroRapido.length;
        document.getElementById('pacientes-incompletos-turnos').textContent = `${pacientesConTurnos.size} con turnos pendientes`;
        
        pacientesRegistroRapido.forEach(paciente => {
          // Buscar turnos pendientes de este paciente
          const turnosPaciente = turnosPendientes.filter(t => t.dni_paciente === paciente.dni);
          const tieneTurnosPendientes = turnosPaciente.length > 0;
          
          const row = document.createElement('tr');
          row.className = tieneTurnosPendientes ? 'bg-yellow-50 hover:bg-yellow-100 border-l-4 border-warning' : 'bg-blue-50 hover:bg-blue-100';
          
          // Informaci√≥n de turnos pendientes
          let infoTurnos = '';
          if (tieneTurnosPendientes) {
            const turnosInfo = turnosPaciente.map(t => {
              const fecha = t.fecha_turno || t.fecha || '';
              const hora = t.hora_turno || t.hora || '';
              const medico = t.medico || '';
              return `${fecha} ${hora} - ${medico}`;
            }).join(', ');
            infoTurnos = `<div class="mt-1 text-xs text-warning font-semibold"><i class="fas fa-calendar-alt mr-1"></i> Turnos: ${turnosInfo}</div>`;
          }
          
          row.innerHTML = `
            <td class="px-6 py-4 font-semibold text-gray-900">${paciente.dni}</td>
            <td class="px-6 py-4 text-gray-600">
              ${paciente.email || '-'}
              ${infoTurnos}
            </td>
            <td class="px-6 py-4">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${tieneTurnosPendientes ? 'bg-warning text-white' : 'bg-info text-white'}">
                <i class="fas fa-exclamation-triangle mr-1"></i> ${tieneTurnosPendientes ? 'Con Turnos Pendientes' : 'Datos Incompletos'}
              </span>
            </td>
            <td class="px-6 py-4">
              <a href="/pacientes?dni=${paciente.dni}" class="bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded-lg text-sm font-medium transition-colors duration-200 inline-flex items-center">
                <i class="fas fa-edit mr-1"></i> Completar Datos
              </a>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (error) {
        console.error('Error cargando pacientes con registro r√°pido:', error);
      }
    }
    
    function scrollToRegistroRapido() {
      const element = document.getElementById('pacientes-registro-rapido');
      if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Resaltar brevemente
        element.style.transition = 'background-color 0.3s';
        element.style.backgroundColor = '#fef3c7';
        setTimeout(() => {
          element.style.backgroundColor = '';
        }, 2000);
      }
    }

    async function cobrarPacienteRecepcionado(dni, fecha) {
      const montoInput = document.getElementById(`monto-${dni}`);
      const monto = parseFloat(montoInput.value || 0);
      
      if (isNaN(monto) || monto < 0) {
        alert('Por favor ingrese un monto v√°lido (puede ser 0 para obra social)');
        return;
      }
      
      // Si el monto es 0, es obra social y no necesita tipo de pago
      if (monto === 0) {
        const observaciones = prompt('Observaciones (opcional):', '') || '';
        await procesarPago(dni, fecha, monto, 'obra_social', observaciones);
        return;
      }
      
      // Para pagos particulares, mostrar modal para seleccionar tipo de pago
      mostrarModalCobro(dni, fecha, monto);
    }
    
    function mostrarModalCobro(dni, fecha, monto) {
      console.log('Iniciando modal de cobro para:', dni, fecha, monto);
      
      // Crear modal din√°micamente con Tailwind CSS
      const modalHtml = `
        <div id="modalCobro" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]" style="z-index: 9999 !important;">
          <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
              <h5 class="text-xl font-semibold text-gray-900 flex items-center">
                <i class="fas fa-cash-register text-green-600 mr-2"></i>
                Registrar Pago
              </h5>
              <button type="button" class="text-gray-400 hover:text-gray-600 transition-colors" onclick="cerrarModalCobro()">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <div class="mb-4">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                <strong>Monto a cobrar:</strong> $${monto}
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-credit-card mr-2"></i>Tipo de Pago:
                </label>
                <select class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" id="tipo-pago-select">
                  <option value="efectivo">Efectivo</option>
                  <option value="transferencia">Transferencia</option>
                </select>
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-comment mr-2"></i>Observaciones (opcional):
                </label>
                <textarea class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" id="observaciones-pago" rows="3" placeholder="Observaciones adicionales..."></textarea>
              </div>
            </div>
            
            <div class="flex justify-end space-x-3">
              <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg font-semibold transition-colors duration-200 flex items-center space-x-2" onclick="cerrarModalCobro()">
                <i class="fas fa-times"></i> 
                <span>Cancelar</span>
              </button>
              <button type="button" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors duration-200 flex items-center space-x-2" onclick="confirmarPago('${dni}', '${fecha}', ${monto})">
                <i class="fas fa-check"></i> 
                <span>Confirmar Pago</span>
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Remover modal anterior si existe
      const modalAnterior = document.getElementById('modalCobro');
      if (modalAnterior) {
        console.log('Removiendo modal anterior...');
        modalAnterior.remove();
      }
      
      // Agregar modal al DOM
      console.log('Agregando modal al DOM...');
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      console.log('Modal de cobro mostrado exitosamente');
    }
    // Funci√≥n para cerrar modal de cobro
    function cerrarModalCobro() {
      const modalElement = document.getElementById('modalCobro');
      if (modalElement) {
        modalElement.remove();
        console.log('Modal de cobro cerrado y removido');
      }
    }

    async function confirmarPago(dni, fecha, monto) {
      console.log('Confirmando pago para:', dni, fecha, monto);
      
      const tipoPago = document.getElementById('tipo-pago-select').value;
      const observaciones = document.getElementById('observaciones-pago').value || '';
      
      console.log('Tipo de pago seleccionado:', tipoPago);
      console.log('Observaciones:', observaciones);
      
      // Cerrar modal
      cerrarModalCobro();
      
      await procesarPago(dni, fecha, monto, tipoPago, observaciones);
    }
    
    async function procesarPago(dni, fecha, monto, tipoPago, observaciones) {
      console.log('Procesando pago:', { dni, fecha, monto, tipoPago, observaciones });
      
      try {
        const requestData = {
          dni_paciente: dni,
          fecha: fecha,
          monto: monto,
          tipo_pago: tipoPago,
          observaciones: observaciones
        };
        
        console.log('Enviando datos al servidor:', requestData);
        
        const response = await fetch('/api/pagos/cobrar-y-sala', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestData)
        });
        
        console.log('Respuesta del servidor:', response.status, response.statusText);
        
        const result = await response.json();
        console.log('Resultado:', result);
        
        if (response.ok) {
          if (monto > 0) {
            const tipoTexto = tipoPago === 'efectivo' ? 'en efectivo' : 'por transferencia';
            alert(`‚úÖ Pago de $${monto} ${tipoTexto} registrado correctamente\nüè• Paciente movido a sala de espera`);
          } else {
            alert(`‚úÖ Consulta cubierta por obra social\nüè• Paciente movido a sala de espera`);
          }
          
          // Recargar datos
          await cargarDatos();
          await cargarTurnosHoy(); // Actualizar tabla de turnos
          cargarPacientesRecepcionados();
          cargarPacientesSalaEspera(); //Recargar sala de espera
          cargarPagosHoy();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        console.error('Error al procesar pago:', error);
        alert('Error al cobrar: ' + error.message);
      }
    }
    
    async function eliminarPago(pagoId, nombrePaciente) {
      if (confirm(`¬øEst√° seguro de que desea eliminar el pago de ${nombrePaciente}?`)) {
        try {
          const response = await fetch(`/api/pagos/${pagoId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            }
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('Pago eliminado correctamente');
            await cargarDatos(); // Recargar estad√≠sticas
            cargarPacientesRecepcionados(); // Recargar recepcionados
            cargarPagosHoy(); // Actualizar tabla
          } else {
            alert('Error: ' + result.error);
          }
        } catch (error) {
          alert('Error al eliminar pago: ' + error.message);
        }
      }
    }
    

    async function exportarPagosCSV() {
      try {
        const response = await fetch('/api/pagos/exportar');
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = `pagos_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          alert('Archivo CSV descargado correctamente');
        } else {
          alert('Error al exportar archivo CSV');
        }
      } catch (error) {
        alert('Error al exportar CSV: ' + error.message);
      }
    }

    // === FUNCIONES PARA NUEVO PAGO ===
    
    let pacienteSeleccionadoPago = null;
    let timeoutBusqueda = null;
    
    function mostrarModalNuevoPago() {
      console.log('Mostrando modal nuevo pago con Tailwind CSS...');
      
      // Limpiar el modal
      document.getElementById('nuevoPago-buscarPaciente').value = '';
      document.getElementById('resultadosBusquedaPaciente').innerHTML = '';
      document.getElementById('datosPacienteSeleccionado').classList.add('hidden');
      document.getElementById('btnGuardarPago').disabled = true;
      pacienteSeleccionadoPago = null;
      
      // Establecer fecha y hora actuales
      const ahora = new Date();
      document.getElementById('nuevoPago-fecha').value = ahora.toISOString().split('T')[0];
      document.getElementById('nuevoPago-hora').value = ahora.toTimeString().substring(0, 5);
      
      // Mostrar modal
      const modal = document.getElementById('modalNuevoPago');
      modal.classList.remove('hidden');
      console.log('Modal mostrado exitosamente');
      
      // Enfocar el primer input
      setTimeout(() => {
        const firstInput = document.getElementById('nuevoPago-buscarPaciente');
        if (firstInput) {
          firstInput.focus();
          console.log('Input enfocado:', firstInput);
        }
      }, 100);
    }
    
    function cerrarModalNuevoPago() {
      console.log('Cerrando modal nuevo pago...');
      const modal = document.getElementById('modalNuevoPago');
      modal.classList.add('hidden');
      console.log('Modal cerrado exitosamente');
    }
    
    function limpiarModalesExistentes() {
      console.log('Limpiando modales existentes...');
      
      // Remover todos los backdrops
      const backdrops = document.querySelectorAll('.modal-backdrop');
      backdrops.forEach(backdrop => {
        console.log('Removiendo backdrop:', backdrop);
        backdrop.remove();
      });
      
      // Remover clases show de todos los modales
      const modales = document.querySelectorAll('.modal');
      modales.forEach(modal => {
        if (modal.classList.contains('show')) {
          console.log('Removiendo clase show de modal:', modal.id);
          modal.classList.remove('show');
          modal.style.display = 'none';
        }
      });
      
      // Remover clase modal-open del body
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
      
      console.log('Limpieza de modales completada');
    }
    
    function mostrarModalAlternativo(modalElement) {
      console.log('Usando m√©todo alternativo para mostrar modal...');
      
      try {
        // Crear backdrop manualmente
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.style.zIndex = '1040';
        document.body.appendChild(backdrop);
        
        // Mostrar modal manualmente
        modalElement.classList.add('show');
        modalElement.style.display = 'block';
        modalElement.style.zIndex = '1050';
        modalElement.setAttribute('aria-modal', 'true');
        modalElement.setAttribute('role', 'dialog');
        
        // Agregar clase al body
        document.body.classList.add('modal-open');
        document.body.style.overflow = 'hidden';
        
        // Agregar event listener para cerrar con ESC
        const escHandler = (e) => {
          if (e.key === 'Escape') {
            cerrarModalAlternativo(modalElement, backdrop, escHandler);
          }
        };
        document.addEventListener('keydown', escHandler);
        
        // Agregar event listener para cerrar con click en backdrop
        backdrop.addEventListener('click', () => {
          cerrarModalAlternativo(modalElement, backdrop, escHandler);
        });
        
        console.log('Modal mostrado con m√©todo alternativo exitosamente');
        
      } catch (error) {
        console.error('Error en m√©todo alternativo:', error);
        alert('Error cr√≠tico al mostrar modal: ' + error.message);
      }
    }
    
    function cerrarModalAlternativo(modalElement, backdrop, escHandler) {
      console.log('Cerrando modal con m√©todo alternativo...');
      
      try {
        // Remover event listeners
        document.removeEventListener('keydown', escHandler);
        
        // Ocultar modal
        modalElement.classList.remove('show');
        modalElement.style.display = 'none';
        modalElement.removeAttribute('aria-modal');
        modalElement.removeAttribute('role');
        
        // Remover backdrop
        if (backdrop && backdrop.parentNode) {
          backdrop.remove();
        }
        
        // Restaurar body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        
        console.log('Modal cerrado con m√©todo alternativo exitosamente');
        
      } catch (error) {
        console.error('Error al cerrar modal alternativo:', error);
      }
    }
    
    function buscarPacienteParaPago() {
      const busqueda = document.getElementById('nuevoPago-buscarPaciente').value.trim();
      const resultados = document.getElementById('resultadosBusquedaPaciente');
      
      // Limpiar timeout anterior
      if (timeoutBusqueda) {
        clearTimeout(timeoutBusqueda);
      }
      
      if (busqueda.length < 2) {
        resultados.innerHTML = '';
        return;
      }
      
      // Buscar con delay para evitar muchas b√∫squedas
      timeoutBusqueda = setTimeout(() => {
        const pacientesFiltrados = pacientes.filter(p => {
          const texto = busqueda.toLowerCase();
          return p.dni.includes(texto) || 
                 (p.nombre && p.nombre.toLowerCase().includes(texto)) ||
                 (p.apellido && p.apellido.toLowerCase().includes(texto));
        }).slice(0, 10); // M√°ximo 10 resultados
        
        if (pacientesFiltrados.length === 0) {
          resultados.innerHTML = '<div class="text-gray-500 text-sm p-3">No se encontraron pacientes</div>';
          return;
        }
        
        let html = '<div class="space-y-1">';
        pacientesFiltrados.forEach(p => {
          html += `
            <button type="button" class="w-full text-left p-3 border border-gray-200 rounded-md hover:bg-gray-50 hover:border-primary transition-colors" onclick="seleccionarPacientePago('${p.dni}')">
              <div class="flex justify-between items-center">
                <div>
                  <div class="font-semibold text-gray-900">${p.apellido}, ${p.nombre}</div>
                  <div class="text-sm text-gray-500">DNI: ${p.dni}</div>
                </div>
                <div class="text-right">
                  <div class="text-sm text-gray-500">${p.obra_social || 'Sin OS'}</div>
                </div>
              </div>
            </button>
          `;
        });
        html += '</div>';
        resultados.innerHTML = html;
      }, 300);
    }
    
    function seleccionarPacientePago(dni) {
      pacienteSeleccionadoPago = pacientes.find(p => p.dni === dni);
      if (!pacienteSeleccionadoPago) return;
      
      // Mostrar informaci√≥n del paciente seleccionado
      document.getElementById('infoPacienteSeleccionado').innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
          <div><strong>DNI:</strong> ${pacienteSeleccionadoPago.dni}</div>
          <div><strong>Nombre:</strong> ${pacienteSeleccionadoPago.nombre} ${pacienteSeleccionadoPago.apellido}</div>
          <div><strong>Obra Social:</strong> ${pacienteSeleccionadoPago.obra_social || 'No especificada'}</div>
          <div><strong>Celular:</strong> ${pacienteSeleccionadoPago.celular || 'No especificado'}</div>
        </div>
      `;
      
      // Ocultar resultados de b√∫squeda y mostrar formulario
      document.getElementById('resultadosBusquedaPaciente').innerHTML = '';
      document.getElementById('datosPacienteSeleccionado').classList.remove('hidden');
      document.getElementById('btnGuardarPago').disabled = false;
      
      // Pre-llenar algunos campos si es obra social
      if (pacienteSeleccionadoPago.obra_social && pacienteSeleccionadoPago.obra_social !== '0') {
        document.getElementById('nuevoPago-tipoPago').value = 'obra_social';
        document.getElementById('nuevoPago-monto').value = '0';
      }
    }
    
    async function registrarNuevoPago() {
      if (!pacienteSeleccionadoPago) {
        alert('Debe seleccionar un paciente');
        return;
      }
      const datos = {
        dni_paciente: pacienteSeleccionadoPago.dni,
        nombre_paciente: `${pacienteSeleccionadoPago.nombre} ${pacienteSeleccionadoPago.apellido}`,
        fecha: document.getElementById('nuevoPago-fecha').value,
        hora: document.getElementById('nuevoPago-hora').value,
        monto: parseFloat(document.getElementById('nuevoPago-monto').value) || 0,
        tipo_pago: document.getElementById('nuevoPago-tipoPago').value,
        observaciones: document.getElementById('nuevoPago-observaciones').value.trim(),
        obra_social: pacienteSeleccionadoPago.obra_social || ''
      };
      
      // Validaciones
      if (!datos.fecha || !datos.hora || !datos.tipo_pago) {
        alert('Complete todos los campos obligatorios');
        return;
      }
      
      if (datos.tipo_pago !== 'obra_social' && datos.monto <= 0) {
        alert('El monto debe ser mayor a 0 para pagos en efectivo y transferencia');
        return;
      }
      
      // Primero probar conectividad b√°sica
      try {
        console.log('Probando conectividad b√°sica...');
        const testResponse = await fetch('/api/pacientes');
        console.log('Test de conectividad:', testResponse.status);
        
        if (!testResponse.ok) {
          throw new Error(`Error de conectividad: ${testResponse.status}`);
        }
      } catch (testError) {
        console.error('Error de conectividad:', testError);
        alert('Error de conectividad con el servidor: ' + testError.message);
        return;
      }
      
      try {
        console.log('Enviando datos de pago:', datos);
        
        const response = await fetch('/api/pagos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(datos)
        });
        
        console.log('Respuesta del servidor:', response.status, response.statusText);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Error del servidor:', errorText);
          alert('Error del servidor: ' + response.status + ' - ' + errorText);
          return;
        }
        
        const resultado = await response.json();
        console.log('Resultado:', resultado);
        
        alert('Pago registrado exitosamente');
        
        // Cerrar modal
        cerrarModalNuevoPago();
        
        // Actualizar listas
        await cargarDatos();
        actualizarGestionPagos();
        
      } catch (error) {
        console.error('Error detallado:', error);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        alert('Error de conexi√≥n al registrar pago: ' + error.message);
      }
    }
    
    // Funci√≥n para actualizar dashboard
    async function actualizarDashboard() {
      try {
        await cargarDatos();
        await actualizarEstadisticas();
        await cargarTurnosHoy();
        
        // Actualizar timestamp
        const ahora = new Date();
        const timestamp = ahora.toLocaleTimeString('es-ES', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        document.getElementById('ultima-actualizacion').textContent = timestamp;
        
        // Mostrar mensaje de √©xito
        const boton = event.target.closest('button');
        const icono = boton.querySelector('i');
        const textoOriginal = icono.className;
        
        // Cambiar icono temporalmente
        icono.className = 'fas fa-check text-green-500';
        setTimeout(() => {
          icono.className = textoOriginal;
        }, 1000);
        
      } catch (error) {
        console.error('Error actualizando dashboard:', error);
        alert('Error al actualizar el dashboard');
      }
    }

    // Funci√≥n para vaciar turnos vencidos
    function vaciarTurnosVencidos() {
      if (!confirm("¬øSeguro que quieres eliminar todos los turnos 'sin atender' vencidos hace m√°s de 24hs?")) return;
      fetch('/api/turnos/limpiar-vencidos', {method: 'POST'})
        .then(r => r.json())
        .then(res => {
          alert(`Turnos eliminados: ${res.eliminados}`);
          // Recargar la tabla de turnos si existe funci√≥n
          if (typeof cargarTurnosHoy === 'function') cargarTurnosHoy();
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al limpiar turnos vencidos');
        });
    }

    // Funci√≥n para cerrar sesi√≥n
    function cerrarSesion() {
      if (confirm('¬øEst√° seguro de que desea cerrar sesi√≥n?')) {
        // Realizar logout
        fetch('/logout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => {
          if (response.ok) {
            // Redirigir al login
            window.location.href = '/login';
          } else {
            alert('Error al cerrar sesi√≥n');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al cerrar sesi√≥n');
        });
      }
    }

    // ===================== BUSQUEDA RAPIDA (DNI o APELLIDO) =====================
    async function buscarPaciente() {
      try {
        const texto = (document.getElementById('buscar-paciente')?.value || '').trim().toLowerCase();
        const fecha = (document.getElementById('buscar-fecha')?.value || '').trim();
        
        // Requerir texto (DNI o apellido), fecha es opcional
        if (!texto) {
          alert('Ingrese DNI o apellido para buscar');
          return;
        }
        
        const [turnos, pacientes] = await Promise.all([
          fetch('/api/turnos').then(r => r.json()),
          fetch('/api/pacientes').then(r => r.json())
        ]);
        
        const dniToPaciente = new Map(pacientes.map(p => [String(p.dni), p]));
        
        // Filtrar por texto (DNI, apellido o nombre)
        let resultados = turnos.filter(t => {
          const dni = String(t.dni_paciente || '');
          const p = dniToPaciente.get(dni) || {};
          const ape = (p.apellido || '').toLowerCase();
          const nom = (p.nombre || '').toLowerCase();
          return dni.includes(texto) || ape.includes(texto) || nom.includes(texto);
        });

        // Filtrar solo turnos futuros (>= ahora)
        const ahora = new Date();
        resultados = resultados.filter(t => {
          const f = (t.fecha || t.fecha_turno || '').trim();
          const h = (t.hora || t.hora_turno || '00:00').trim();
          if (!f) return false;
          
          // Crear fecha/hora del turno
          const horaCompleta = h.length === 5 ? h : '00:00';
          const dt = new Date(`${f}T${horaCompleta}`);
          
          // Si la fecha es v√°lida y es futura
          if (isNaN(dt.getTime())) return false;
          
          // Si hay fecha espec√≠fica en el filtro, verificar que coincida
          if (fecha && f !== fecha) return false;
          
          // Solo mostrar turnos futuros
          return dt >= ahora;
        }).slice(0, 200); // limitar por performance

        // Ordenar por fecha y hora (m√°s pr√≥ximos primero)
        resultados.sort((a, b) => {
          const fechaA = (a.fecha || a.fecha_turno || '') + ' ' + (a.hora || a.hora_turno || '00:00');
          const fechaB = (b.fecha || b.fecha_turno || '') + ' ' + (b.hora || b.hora_turno || '00:00');
          return fechaA.localeCompare(fechaB);
        });

        if (resultados.length === 0) {
          alert('No se encontraron turnos futuros para el paciente consultado');
          return;
        }

        mostrarModalBusquedaRapida(resultados, dniToPaciente);
      } catch (e) {
        alert('Error en la b√∫squeda: ' + e.message);
        console.error('Error en buscarPaciente:', e);
      }
    }

    function mostrarModalBusquedaRapida(resultados, dniToPaciente) {
      const tbody = resultados.map(t => {
        const p = dniToPaciente.get(String(t.dni_paciente || '')) || {};
        const apellido = p.apellido || '';
        const nombre = p.nombre || '';
        const obra = p.obra_social || '';
        const fecha = t.fecha || t.fecha_turno || '';
        const hora = t.hora || t.hora_turno || '';
        return `
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-2">${fecha}</td>
            <td class="px-3 py-2">${hora}</td>
            <td class="px-3 py-2">${t.dni_paciente || ''}</td>
            <td class="px-3 py-2">${apellido}</td>
            <td class="px-3 py-2">${nombre}</td>
            <td class="px-3 py-2">${obra}</td>
            <td class="px-3 py-2">${t.medico || ''}</td>
            <td class="px-3 py-2 capitalize">${t.estado || 'sin atender'}</td>
          </tr>
        `;
      }).join('');

      // Modal estilo Tailwind (como el de Nuevo Pago)
      const modalHtml = `
        <div id="busquedaRapidaModalTW" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]" style="z-index: 9999 !important;">
          <div class="bg-white rounded-lg p-6 w-full max-w-5xl mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
              <h5 class="text-xl font-semibold text-gray-900">Resultados de B√∫squeda</h5>
              <button type="button" class="text-gray-400 hover:text-gray-600 transition-colors" onclick="(function(){const m=document.getElementById('busquedaRapidaModalTW'); if(m) m.remove();})();">‚úï</button>
            </div>
            <div class="overflow-auto max-h-[70vh]">
              <table class="min-w-full text-sm text-left text-gray-600">
                <thead class="bg-gray-50 text-gray-700 uppercase text-xs">
                  <tr>
                    <th class="px-3 py-2">Fecha</th>
                    <th class="px-3 py-2">Hora</th>
                    <th class="px-3 py-2">DNI</th>
                    <th class="px-3 py-2">Apellido</th>
                    <th class="px-3 py-2">Nombre</th>
                    <th class="px-3 py-2 hidden md:table-cell">Obra Social</th>
                    <th class="px-3 py-2 hidden md:table-cell">M√©dico</th>
                    <th class="px-3 py-2 hidden md:table-cell">Estado</th>
                  </tr>
                </thead>
                <tbody>
                  ${tbody || '<tr><td colspan="6" class="text-center text-gray-500 py-6">Sin resultados</td></tr>'}
                </tbody>
              </table>
            </div>
            <div class="mt-4 text-right">
              <button class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-md" onclick="(function(){const m=document.getElementById('busquedaRapidaModalTW'); if(m) m.remove();})();">Cerrar</button>
            </div>
          </div>
        </div>`;

      const existing = document.getElementById('busquedaRapidaModalTW');
      if (existing) existing.remove();
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    // Funci√≥n para actualizar fecha de hoy en estad√≠sticas
    function actualizarFechaHoy() {
      const hoy = new Date();
      const fechaFormateada = hoy.toLocaleDateString('es-ES', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      const elementoFecha = document.getElementById('fecha-hoy');
      if (elementoFecha) {
        elementoFecha.textContent = fechaFormateada;
      }
    }

    // Cargar datos al iniciar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM cargado, iniciando aplicaci√≥n...');
      
      // Actualizar fecha de hoy
      actualizarFechaHoy();
      
      // Cargar datos iniciales
      cargarDatos().then(() => {
        console.log('Datos cargados exitosamente');
      }).catch(error => {
        console.error('Error al cargar datos iniciales:', error);
      });
      
      // Limpiar modales cuando se cierren (solo si Bootstrap est√° disponible)
      if (typeof bootstrap !== 'undefined') {
        document.addEventListener('hidden.bs.modal', function (event) {
          const modalId = event.target.id;
          console.log('Modal cerrado:', modalId);
          
          if (modalId === 'modalCobro') {
            // Limpiar modal de cobro
            const modalElement = document.getElementById('modalCobro');
            if (modalElement) {
              modalElement.remove();
              console.log('Modal de cobro removido del DOM');
            }
          }
        });
      }
    });
  </script>

  <!-- Modal para Nuevo Pago (Tailwind CSS) -->
  <div id="modalNuevoPago" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] hidden" style="z-index: 9999 !important;">
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h5 class="text-xl font-semibold text-gray-900 flex items-center">
          <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
          </svg>
          Registrar Nuevo Pago
        </h5>
        <button type="button" class="text-gray-400 hover:text-gray-600 transition-colors" onclick="cerrarModalNuevoPago()">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <form id="formNuevoPago">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
            <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            Buscar Paciente
          </label>
          <input 
            type="text" 
            id="nuevoPago-buscarPaciente" 
            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" 
            placeholder="Escriba DNI, nombre o apellido..." 
            oninput="buscarPacienteParaPago()"
          >
          <div id="resultadosBusquedaPaciente" class="mt-2 max-h-48 overflow-y-auto border border-gray-200 rounded-md"></div>
        </div>
        
        <div id="datosPacienteSeleccionado" class="hidden">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <h6 class="font-semibold text-blue-800 flex items-center mb-2">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              Paciente Seleccionado:
            </h6>
            <div id="infoPacienteSeleccionado" class="text-blue-700"></div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Fecha</label>
              <input type="date" id="nuevoPago-fecha" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Hora</label>
              <input type="time" id="nuevoPago-hora" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Monto ($)</label>
              <input type="number" id="nuevoPago-monto" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" min="0" step="0.01" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Pago</label>
              <select id="nuevoPago-tipoPago" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                <option value="">Seleccione...</option>
                <option value="efectivo">Efectivo</option>
                <option value="transferencia">Transferencia</option>
                <option value="obra_social">Obra Social</option>
              </select>
            </div>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Observaciones</label>
            <textarea 
              id="nuevoPago-observaciones" 
              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" 
              rows="3" 
              placeholder="Comentarios adicionales (opcional)..."
            ></textarea>
          </div>
        </div>
      </form>
      
      <div class="flex justify-end space-x-3">
        <button type="button" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors flex items-center" onclick="cerrarModalNuevoPago()">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          Cancelar
        </button>
        <button type="button" class="bg-success text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors flex items-center" onclick="registrarNuevoPago()" id="btnGuardarPago" disabled>
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Registrar Pago
        </button>
      </div>
    </div>
  </div>

  <!-- Footer con licencia -->
  <footer class="bg-gray-900 text-white py-8 mt-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <div class="flex items-center justify-center space-x-2 mb-4">
          <i class="fas fa-heart text-red-500"></i>
          <span class="text-lg font-semibold">Sistema de Gesti√≥n de Consultorio</span>
        </div>
        <p class="text-gray-400 mb-2">Desarrollado con ‚ù§Ô∏è para mejorar la atenci√≥n m√©dica</p>
        <div class="border-t border-gray-700 pt-4">
          <p class="text-sm text-gray-500">
            ¬© 2025 Consultorios Colom. Desarrollado por <span class="font-semibold text-white">Nicolas Fernandez</span>
          </p>
          <p class="text-xs text-gray-600 mt-1">
            Sistema desarrollado para la gesti√≥n integral de consultorios m√©dicos
          </p>
        </div>
      </div>
    </div>
</footer>

<script>
  // Cargar nombre de usuario autenticado en el header
  fetch('/api/session-info')
    .then(r => r.json())
    .then(({ usuario }) => {
      const span = document.getElementById('nombre-usuario');
      if (span && usuario) span.textContent = usuario;
    })
    .catch(() => {});
</script>

</body>
</html>
